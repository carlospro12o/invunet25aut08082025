<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invernadero Automático</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="styles.css" />

    <script type="module">
      import { initializeApp } from "firebase/app";
      import { getAnalytics } from "firebase/analytics";
      import {
        getDatabase,
        ref,
        onValue,
        runTransaction,
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBhHHpiHerkygBFs0tUO8qdeiVbMKJ6iwg",
        authDomain: "automatizacion-20cff.firebaseapp.com",
        databaseURL: "https://automatizacion-20cff-default-rtdb.firebaseio.com",
        projectId: "automatizacion-20cff",
        storageBucket: "automatizacion-20cff.firebasestorage.app",
        messagingSenderId: "1089538837111",
        appId: "1:1089538837111:web:2e41e37e8747a34603d472",
        measurementId: "G-3KHHJ9YJSH",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      function updateSensorData(sensor, value, status) {
        document.getElementById(sensor).textContent = value;
        document.getElementById(sensor + "-status").textContent = status;
      }

      function setupFirebaseListeners() {
        onValue(ref(db, "invernadero/temperatura"), (snapshot) => {
          const data = snapshot.val();
          updateSensorData(
            "temperature",
            data.valor + " °C",
            data.estado || "Actualizado"
          );
        });

        onValue(ref(db, "invernadero/humedad"), (snapshot) => {
          const data = snapshot.val();
          updateSensorData(
            "humidity",
            data.valor + " %",
            data.estado || "Actualizado"
          );
        });

        onValue(ref(db, "invernadero/luz"), (snapshot) => {
          const data = snapshot.val();
          const lightStatus = data.valor ? "Día" : "Noche";
          updateSensorData("light", lightStatus, data.estado || "Actualizado");
        });

        onValue(ref(db, "invernadero/controles"), (snapshot) => {
          const data = snapshot.val();
          if (data) {
            const pumpBtn = document.getElementById("water-pump-btn");
            const lightsBtn = document.getElementById("lights-off-btn");

            if (data.bomba) {
              pumpBtn.textContent = "💦 Apagar Bomba de Agua";
              pumpBtn.classList.add("pump-on");
              pumpBtn.classList.remove("pump-off");
            } else {
              pumpBtn.textContent = "💦 Encender Bomba de Agua";
              pumpBtn.classList.add("pump-off");
              pumpBtn.classList.remove("pump-on");
            }

            if (data.luces) {
              lightsBtn.textContent = "🔦 Encender Luces";
              lightsBtn.classList.add("lights-off-active");
              lightsBtn.classList.remove("lights-off");
            } else {
              lightsBtn.textContent = "🔦 Forzar Apagado de Luces";
              lightsBtn.classList.add("lights-off");
              lightsBtn.classList.remove("lights-off-active");
            }

            document.getElementById("control-status").textContent =
              data.modo || "Modo automático activado";
          }
        });
      }

      function toggleWaterPump() {
        const bombaRef = ref(db, "invernadero/controles/bomba");
        runTransaction(bombaRef, (current) => {
          return current === true ? false : true;
        });
      }

      function toggleLights() {
        const lucesRef = ref(db, "invernadero/controles/luces");
        runTransaction(lucesRef, (current) => {
          return current === true ? false : true;
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        setupFirebaseListeners();

        document
          .getElementById("water-pump-btn")
          .addEventListener("click", toggleWaterPump);
        document
          .getElementById("lights-off-btn")
          .addEventListener("click", toggleLights);
      });
    </script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>🌱 Invernadero Automático</h1>
        <p>Monitoreo en tiempo real</p>
      </header>

      <main>
        <!-- Sección de datos -->
        <div class="sensor-data">
          <div class="data-card">
            <h2>🌡️ Temperatura</h2>
            <p class="value" id="temperature">-- °C</p>
            <p class="status">
              Estado: <span id="temp-status">Esperando datos...</span>
            </p>
          </div>

          <div class="data-card">
            <h2>💧 Humedad</h2>
            <p class="value" id="humidity">-- %</p>
            <p class="status">
              Estado: <span id="humidity-status">Esperando datos...</span>
            </p>
          </div>

          <div class="data-card">
            <h2>☀️ Luz</h2>
            <p class="value" id="light">--</p>
            <p class="status">
              Estado: <span id="light-status">Esperando datos...</span>
            </p>
          </div>
        </div>

        <!-- Controles manuales -->
        <div class="controls">
          <h2>⚙️ Controles Manuales</h2>
          <div class="control-buttons">
            <button id="water-pump-btn" class="btn pump-off">
              💦 Encender Bomba de Agua
            </button>
            <button id="lights-off-btn" class="btn lights-off">
              🔦 Forzar Apagado de Luces
            </button>
          </div>
          <p id="control-status">Modo automático activado.</p>
        </div>

        <!-- Gráfico simulado -->
        <div class="chart-container">
          <h2>📊 Historial de Datos</h2>
          <div class="chart-placeholder">
            <p>(Aquí irá un gráfico con datos de temperatura, humedad y luz)</p>
          </div>
        </div>
      </main>

      <footer>
        <p>Sistema de monitoreo para invernadero | © 2025</p>
        <p>Si lees esto nos das 100 puntos para el Proyecto</p>
      </footer>
    </div>
  </body>
</html>
